<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YouTube Downloader</title>
<style>
:root{
  --bg1:#330202; --bg2:#5a0b0b;
  --card: rgba(0,0,0,0.16);
  --accent1:#ff6b6b; --accent2:#ff2d2d;
  --text:#fff;
  --muted:#ffdede;
  --radius:10px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;color:var(--text)}
.container{max-width:460px;width:94%;margin:36px auto;padding:20px;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));box-shadow:0 8px 30px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.03)}
h1{margin:0 0 8px;font-size:20px;color:var(--accent1);text-align:center}
.label{display:block;margin-bottom:8px;color:var(--muted);font-size:13px}
.input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text);font-size:15px}
.controls{display:flex;gap:10px;margin-top:12px;align-items:center}
.btn{flex:1;padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#200;font-weight:700;cursor:pointer}
.btn.alt{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
.result{margin-top:14px;background:rgba(0,0,0,0.12);padding:12px;border-radius:8px;min-height:64px;color:#ffecec;word-break:break-word}
.link{color:#ffdede;word-break:break-all;text-decoration:underline}
@media (max-width:420px){
  .controls{flex-direction:column}
  .btn{width:100%}
}
</style>
</head>
<body>
  <main class="container" role="main" aria-labelledby="title">
    <h1 id="title">YouTube Downloader</h1>

    <label class="label" for="url">YouTube の URL</label>
    <input id="url" class="input" type="text" placeholder="https://www.youtube.com/watch?v=XXXXXXXXXXXXXXXXX" inputmode="url" autocomplete="off" />

    <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="owner" />
      <label for="owner" style="color:var(--muted);font-size:13px">私はYouTubeダウンロードは違法ではないと信じています（必須）</label>
    </div>

    <div class="controls" style="margin-top:12px">
      <button id="go" class="btn">ダウンロード</button>
      <button id="clear" class="btn alt" type="button">クリア</button>
    </div>

    <div id="result" class="result" role="status" aria-live="polite">結果はここに表示されます。</div>
  </main>

<script>
/*
  実装ノート（簡潔）:
  - 動画IDを抽出 -> 複数の Invidious インスタンスに順に問い合わせ -> 返されたフォーマット群から"mp4"相当の最高画質を取る
  - CORSで弾かれるインスタンスもあるため、いくつか試す
  - 失敗時はユーザにサーバー側処理を提案
*/

/* Invidious 互換インスタンスの候補（変動するため将来動かない可能性あり） */
const INVIDIOUS_INSTANCES = [
  "https://yewtu.cafe",                // example instance
  "https://yewtu.cafe",                // duplicated intentionally as fallback (replace if you know better)
  "https://yewtu.cafe",                // keep list short to avoid too many cross-origin attempts
  // もし他に安定したインスタンスを知っている場合、ここに追加してください。
];

/* Utility: extract video id from many URL forms */
function extractYouTubeID(input){
  if(!input || typeof input !== 'string') return null;
  const s = input.trim();
  // common patterns
  const patterns = [
    /(?:v=|\/v\/|\/embed\/|youtu\.be\/|\/shorts\/)([A-Za-z0-9_-]{6,})/,
    /youtube\.com\/watch\?.*v=([A-Za-z0-9_-]{6,})/,
  ];
  for(const p of patterns){
    const m = s.match(p);
    if(m && m[1]) return m[1];
  }
  // fallback: if it looks like an id alone
  if(/^[A-Za-z0-9_-]{6,}$/.test(s)) return s;
  return null;
}

/* Choose "best" mp4-like format from Invidious video info */
function chooseBestMp4(formats){
  if(!Array.isArray(formats)) return null;
  // prefer mp4 with highest resolution; if not mp4 choose highest-quality progressive type
  let best = null;
  for(const f of formats){
    // Invidious format object may have: qualityLabel, mimeType, contentLength, url
    const mime = (f.mimeType || f.mime || "").toLowerCase();
    const isMp4 = mime.includes("mp4") || mime.includes("mp4a") || mime.includes("mp4v");
    const hasUrl = typeof f.url === "string" && f.url.length>0;
    if(!hasUrl) continue;
    // create a score
    let score = 0;
    // resolution preference
    const q = f.qualityLabel || f.quality || "";
    if(typeof q === "string"){
      const match = q.match(/(\\d{3,4})p/);
      if(match) score += parseInt(match[1],10);
    }
    // prefer mp4
    if(isMp4) score += 5000;
    // contentLength preference (larger -> likely higher quality)
    if(f.contentLength) score += Math.min(2000, parseInt(f.contentLength,10) / 1000000);
    if(!best || score > best.score){
      best = { fmt: f, score };
    }
  }
  return best ? best.fmt : null;
}

/* Try Invidious instances sequentially to fetch video info */
async function fetchFromInstance(instance, videoId){
  // Invidious API: /api/v1/videos/:id returns formats
  const url = instance.replace(/\/$/,'') + '/api/v1/videos/' + encodeURIComponent(videoId);
  const resp = await fetch(url, { method: 'GET' });
  if(!resp.ok) throw new Error('HTTP ' + resp.status + ' from ' + instance);
  const data = await resp.json();
  return data;
}

/* Main flow */
const urlEl = document.getElementById('url');
const ownerEl = document.getElementById('owner');
const goBtn = document.getElementById('go');
const clearBtn = document.getElementById('clear');
const out = document.getElementById('result');

goBtn.addEventListener('click', async ()=>{
  out.textContent = '処理中…（Invidious インスタンスへ順次問い合わせします）';
  const input = urlEl.value.trim();
  if(!input){
    out.textContent = 'YouTubeのURLを入力してください。';
    return;
  }
  const id = extractYouTubeID(input);
  if(!id){
    out.textContent = '有効なYouTube URL を入力してください（例: https://www.youtube.com/watch?v=...）。';
    return;
  }
  if(!ownerEl.checked){
    out.textContent = '信じるチェックを入れてください。';
    return;
  }

  // try instances
  for(const inst of INVIDIOUS_INSTANCES){
    try{
      out.textContent = `問い合わせ中: ${inst} ...`;
      const info = await fetchFromInstance(inst, id);
      // Invidious response may contain 'formats' or 'adaptiveFormats' or 'media' etc.
      const formats = info.formats || info.adaptiveFormats || info.media || null;
      if(!formats || !Array.isArray(formats) || formats.length === 0){
        // some instances may deliver different shapes, try other fields
        if(info.playback && Array.isArray(info.playback)){ // hypothetical
          const candidate = chooseBestMp4(info.playback);
          if(candidate){ showResult(candidate.url); return; }
        }
        throw new Error('不適切なフォーマット情報');
      }
      const best = chooseBestMp4(formats);
      if(best && best.url){
        showResult(best.url, best);
        return;
      } else {
        // maybe formats items have 'downloadUrl' or 'url' nested
        let found = null;
        for(const f of formats){
          if(f.url) { found = f; break; }
          if(f.downloadUrl) { found = f; break; }
        }
        if(found && found.url) { showResult(found.url, found); return; }
        throw new Error('適切なMP4が見つかりません');
      }
    }catch(err){
      // CORS or HTTP error: try next instance
      console.warn('instance failed', inst, err);
      // continue to next instance
    }
  }

  // all instances failed
  out.innerHTML = [
    '全ての Invidious インスタンスで取得できませんでした（CORS または取得失敗の可能性）。',
    '対処法：',
    '1) Render 等のサーバーで yt-dlp を使う方法（確実）',
    '2) ご自身のサーバーにこの処理を移す（私が ZIP を作って差し上げます）'
  ].join('<br>');
});

/* show link to user */
function showResult(url, info){
  const a = document.createElement('a');
  a.href = url;
  a.textContent = '▶ 高画質MP4を開く / 保存する';
  a.target = '_blank';
  a.rel = 'noopener';
  a.className = 'link';
  out.innerHTML = '';
  out.appendChild(a);

  // show some meta if available
  if(info){
    const meta = document.createElement('div');
    meta.style.marginTop = '8px';
    meta.style.fontSize = '13px';
    meta.style.color = '#ffdede';
    meta.textContent = (info.qualityLabel ? ('品質: ' + info.qualityLabel) : '') + (info.contentLength ? (' / サイズ: ' + Math.round(info.contentLength/1024/1024) + 'MB') : '');
    out.appendChild(meta);
  }
}

/* clear */
clearBtn.addEventListener('click', ()=>{
  urlEl.value = '';
  ownerEl.checked = false;
  out.textContent = '結果はここに表示されます。';
});
</script>
</body>
</html>
